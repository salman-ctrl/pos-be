// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum Role {
  ADMIN
  CASHIER
}

enum TransactionStatus {
  PENDING
  PAID
  CANCELLED
}

enum PaymentType {
  CASH
  QRIS
  TRANSFER
}

enum StockMovementType {
  IN
  OUT
}

enum StockMovementSource {
  SALE
  PURCHASE
  ADJUSTMENT
  RETURN
}

// --- MODELS ---

model User {
  id       Int     @id @default(autoincrement())
  name     String  @db.VarChar(255)
  email    String  @unique @db.VarChar(255)
  password String  @db.VarChar(255)
  role     Role    @default(CASHIER)
  imageUrl String? @map("image_url") @db.Text
  isActive Boolean @default(true) @map("is_active")

  // --- KOLOM BARU UNTUK OTP ---
  otpCode      String?   @map("otp_code") @db.VarChar(6)
  otpExpiresAt DateTime? @map("otp_expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  transactions Transaction[]

  @@map("users")
}

// 2. KATEGORI
model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  imageUrl    String?   @map("image_url") @db.Text
  displayType String    @default("normal") @map("display_type") // Bento Grid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  products    Product[]

  @@map("categories")
}

// 3. PRODUK (UPDATE: TAMBAH DISPLAY TYPE)
model Product {
  id         Int     @id @default(autoincrement())
  categoryId Int     @map("category_id")
  sku        String  @unique @db.VarChar(50)
  name       String  @db.VarChar(255)
  imageUrl   String? @map("image_url") @db.Text

  // --- FITUR BENTO GRID (BARU) ---
  displayType String @default("normal") @map("display_type") // normal, wide, tall, large

  price     Decimal @db.Decimal(15, 2)
  costPrice Decimal @map("cost_price") @db.Decimal(15, 2)
  stock     Int     @default(0)
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  category         Category          @relation(fields: [categoryId], references: [id])
  transactionItems TransactionItem[]
  stockMovements   StockMovement[]

  @@map("products")
}

// 4. CUSTOMER
model Customer {
  id           Int           @id @default(autoincrement())
  memberId     String        @unique @map("member_id") @db.VarChar(20)
  name         String        @db.VarChar(255)
  phone        String?       @unique @db.VarChar(20)
  email        String?       @db.VarChar(255)
  imageUrl     String?       @map("image_url") @db.Text
  displayType  String        @default("normal") @map("display_type")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  transactions Transaction[]

  @@map("customers")
}

// 5. TRANSAKSI
model Transaction {
  id             Int               @id @default(autoincrement())
  userId         Int               @map("user_id")
  customerId     Int?              @map("customer_id")
  invoiceNumber  String            @unique @map("invoice_number") @db.VarChar(50)
  subTotal       Decimal           @map("sub_total") @db.Decimal(15, 2)
  taxAmount      Decimal           @map("tax_amount") @db.Decimal(15, 2)
  discountAmount Decimal           @default(0) @map("discount_amount") @db.Decimal(15, 2)
  grandTotal     Decimal           @map("grand_total") @db.Decimal(15, 2)
  status         TransactionStatus @default(PENDING)
  note           String?           @db.Text
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  user           User              @relation(fields: [userId], references: [id])
  customer       Customer?         @relation(fields: [customerId], references: [id])
  items          TransactionItem[]
  payments       Payment[]

  @@map("transactions")
}

// 6. DETAIL ITEM
model TransactionItem {
  id            Int         @id @default(autoincrement())
  transactionId Int         @map("transaction_id")
  productId     Int         @map("product_id")
  qty           Int
  price         Decimal     @db.Decimal(15, 2)
  costPrice     Decimal     @map("cost_price") @db.Decimal(15, 2)
  createdAt     DateTime    @default(now()) @map("created_at")
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  product       Product     @relation(fields: [productId], references: [id])

  @@map("transaction_items")
}

// 7. PEMBAYARAN
model Payment {
  id            Int         @id @default(autoincrement())
  transactionId Int         @map("transaction_id")
  paymentType   PaymentType @map("payment_type")
  amount        Decimal     @db.Decimal(15, 2)
  referenceId   String?     @map("reference_id") @db.VarChar(255)
  paymentStatus String?     @map("payment_status") @db.VarChar(50)
  createdAt     DateTime    @default(now()) @map("created_at")
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  @@map("payments")
}

// 8. STOK
model StockMovement {
  id          Int                 @id @default(autoincrement())
  productId   Int                 @map("product_id")
  type        StockMovementType
  qty         Int
  source      StockMovementSource
  description String?             @db.Text
  createdAt   DateTime            @default(now()) @map("created_at")
  product     Product             @relation(fields: [productId], references: [id])

  @@map("stock_movements")
}

// 9. SETTINGS
model StoreSetting {
  id               Int      @id @default(autoincrement())
  storeName        String   @default("My POS Store") @map("store_name")
  logoUrl          String?  @map("logo_url") @db.Text
  address          String?  @db.Text
  phone            String?  @db.VarChar(20)
  email            String?  @db.VarChar(255)
  website          String?  @db.VarChar(255)
  enableCash       Boolean  @default(true) @map("enable_cash")
  enableQris       Boolean  @default(false) @map("enable_qris")
  enableDebit      Boolean  @default(false) @map("enable_debit")
  taxRate          Decimal  @default(0) @map("tax_rate") @db.Decimal(5, 2)
  serviceCharge    Decimal  @default(0) @map("service_charge") @db.Decimal(5, 2)
  autoPrintReceipt Boolean  @default(true) @map("auto_print_receipt")
  receiptFooter    String?  @map("receipt_footer") @db.Text
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("store_settings")
}
